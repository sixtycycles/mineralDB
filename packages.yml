---
- name: Updating packages
  become: true
  apt:
    update_cache: true
    autoclean: true
    autoremove: true
    cache_valid_time: 26000

- name: Installing packages
  become: true
  apt:
    pkg: [ 'git', 'python3-pip', 'python3.7-dev', 'python3-pymysql', 'curl', 'virtualenv','nginx','mariadb-server']
    state: latest

- name: Checking everything is up to date
  become: true
  apt:
    upgrade: true

- name: Rebooting if needed...
  shell: sleep 10 && /sbin/shutdown -r now 'reboot post update/upgrade'
  args:
    removes: /var/run/reboot-required
  async: 300
  poll: 0
  ignore_errors: true

- name: Wait for system to become reachable again
  wait_for_connection:
    delay: 60
    timeout: 300
