---
- name: Downloading the project
  become: true
  git: repo={{ repo }} dest=/home/{{prname}}/{{ prname }} accept_hostkey=True

- name: Creating the virtualenv
  become: true
  shell: virtualenv env
  args:
    chdir: /home/{{prname}}

- name: Installing python packages
  become: true
  pip: virtualenv=/home/{{prname}}/env requirements=/home/{{prname}}/{{prname}}/requirements.txt

- name: Installing psycopg2 packages
  become: true
  pip: virtualenv=/home/{{prname}}/env name="psycopg2"

- name: Installing uwsgi packages
  become: true
  pip: virtualenv=/home/{{prname}}/env name="uwsgi"

- name: Creates webstatic directory
  become: true
  file: path=/home/{{prname}}/webstatic state=directory

- name: Creating deploy settings
  become: true
  template: src=templates/deploy.py dest=/home/{{prname}}/{{prname}}/{{prname}}/{{prname}} owner="{{prname}}" mode=0644

- name: Collect static
  become: true
  django_manage: command=collectstatic
  args:
    app_path: /home/{{prname}}/{{prname}}/{{prname}}
    virtualenv: /home/{{prname}}/env
    settings: "{{prname}}.deploy"

- name: Syncdb
  become: true
  django_manage: command=syncdb
  args:
    app_path: /home/{{prname}}/{{prname}}/{{prname}}
    virtualenv: /home/{{prname}}/env
    settings: "{{prname}}.deploy"

- name: Migrate
  become: true
  shell: /home/{{prname}}/env/bin/python manage.py migrate --no-initial-data --settings={{prname}}.deploy
  args:
    chdir: /home/{{prname}}/{{prname}}/{{prname}}

- name: Creating uwsgi settings
  become: true
  template: src=templates/uwsgi.ini dest=/home/{{prname}}/uwsgi.ini owner="{{prname}}" mode=0644
